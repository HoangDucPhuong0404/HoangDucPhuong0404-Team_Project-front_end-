define(['underscore','jquery','Magento_Checkout/js/model/resource-url-manager','Magento_Checkout/js/model/quote','mage/storage','Magento_Checkout/js/model/totals','Magento_Checkout/js/model/error-processor','Magento_Checkout/js/model/cart/cache','Magento_Customer/js/customer-data'],function(_,$,resourceUrlManager,quote,storage,totalsService,errorProcessor,cartCache,customerData){'use strict';var loadFromServer=function(address){var serviceUrl,payload;totalsService.isLoading(true);serviceUrl=resourceUrlManager.getUrlForTotalsEstimationForNewAddress(quote);payload={addressInformation:{address:_.pick(address,cartCache.requiredFields)}};payload.addressInformation.address.city=$('input[name=city]').val();payload.addressInformation.address.customAttributes={city_id:$('select[name=city_id] :selected').val(),district_id:$('select[name=district_id] :selected').val(),district:$('input[name=district]').val(),ward_id:$('select[name=ward_id] :selected').val(),ward:$('input[name=ward]').val()};if(quote.shippingMethod()&&quote.shippingMethod()['method_code']){payload.addressInformation['shipping_method_code']=quote.shippingMethod()['method_code'];payload.addressInformation['shipping_carrier_code']=quote.shippingMethod()['carrier_code'];}
return storage.post(serviceUrl,JSON.stringify(payload),false).done(function(result){var data={totals:result,address:address,cartVersion:customerData.get('cart')()['data_id'],shippingMethodCode:null,shippingCarrierCode:null};if(quote.shippingMethod()&&quote.shippingMethod()['method_code']){data.shippingMethodCode=quote.shippingMethod()['method_code'];data.shippingCarrierCode=quote.shippingMethod()['carrier_code'];}
quote.setTotals(result);cartCache.set('cart-data',data);}).fail(function(response){errorProcessor.process(response);}).always(function(){totalsService.isLoading(false);});};return{requiredFields:cartCache.requiredFields,estimateTotals:function(address){var data={shippingMethodCode:null,shippingCarrierCode:null};if(quote.shippingMethod()&&quote.shippingMethod()['method_code']){data.shippingMethodCode=quote.shippingMethod()['method_code'];data.shippingCarrierCode=quote.shippingMethod()['carrier_code'];}
return loadFromServer(address);}};});